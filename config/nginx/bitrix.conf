# composite enablement file
set $composite_enabled  "/web/prod/bitrix/html_pages/.enabled";
# if test pass through general tests:
set $use_composite_cache "";
# global site test, the same for all sites on the server
if ($is_global_composite = 1) {set $use_composite_cache "A";}
# personal site tests, generated by site config
if ($is_site_composite = 1) {set $use_composite_cache "${use_composite_cache}B";}

# memcached common options
memcached_connect_timeout 1s;
memcached_read_timeout 1s;
memcached_send_timeout 1s;
memcached_gzip_flag 65536;
set $memcached_key "/${host}${composite_key}/index@${args}.html";

include security_headers.conf;

charset utf-8;
index index.php;

# remove multiple slashes
# duplicated slashes will work and won't be rewritten, fixing it in this configuration is tricky
rewrite ^([^.]*?\/)\/+(.*)$ $1$2 permanent;

# main location with processing composite
location / {
    error_page 404 405 412 502 504 = @php-fpm;

    if (-f $composite_enabled) { set $use_composite_cache "${use_composite_cache}C"; }
    if ($use_composite_cache != "ABC") { return 412; }

    default_type text/html;
    memcached_pass memcached:11211;
    add_header X-Bitrix-Composite "Nginx (memcached)";
    include security_headers.conf;
}

location @php-fpm {
    try_files $uri $uri/ /bitrix/urlrewrite.php$is_args$args;
}

location = /restore.php {
    fastcgi_pass php-upstream;
    include fastcgi.conf;

    client_body_buffer_size 8192m;
    client_max_body_size 8192m;
}

location = /favicon.png {
    log_not_found off;
    access_log off;
}

location = /404.html {
    internal;
    access_log off;
    return 404;
}

location ~ (/\.ht|/\.git|/\.gitignore|\.settings\.php|/composer|/bitrix/backup|/bitrix/updates|/bitrix/modules|/bitrix/php_interface|/bitrix/stack_cache|/bitrix/managed_cache|/bitrix/html_pages/\.|/upload/1c_exchange|local/modules|local/php_interface|/logs/) {
    deny all;
}

location ~* ^.+\.(xml|txt|jpeg|jpg|png|gif|bmp|ico|svg|tif|tiff|css|map|js|json|htm|ttf|otf|webp|woff2?|csv|rtf|doc|docx|xls|xlsx|ppt|pptx|odf|odp|ods|odt|pdf|psd|ai|eot|eps|ps|zip|tar|tgz|gz|rar|bz2?|7z|aac|m4a|mp3|mp4|ogg|wav|wma|3gp|avi|flv|m4v|mkv|mov|mpe?g|wmv|exe|iso|dmg|swf|webmanifest)$ {
    error_page 404 /404.html;
    log_not_found off;
    access_log off;
    expires max;
    add_header Cache-Control public;
    include security_headers.conf;
}

# Disable access for non-static assets in cache location
location ~* ^/bitrix/cache { deny all; }

location ~ /upload/ {
    client_body_buffer_size 1024m;
    client_max_body_size 1024m;
}

location ~ \.php$ {
    try_files $uri @php-fpm;
    # redirect index.php to page without it
    if ($request_uri ~* "^(.*/)index\.php$") {
        return 301 $1;
    }

    fastcgi_pass php-upstream;
    include fastcgi.conf;
}
